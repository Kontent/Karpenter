var MooDropMenu=new Class({Implements:[Options,Events],options:{onOpen:function(a){a.removeClass("close").addClass("open")},onClose:function(a){a.removeClass("open").addClass("close")},onInitialize:function(a){a.removeClass("open").addClass("close")},mouseoutDelay:200,mouseoverDelay:0,listSelector:"ul",itemSelector:"li",elementWithFocus:null,timer:null,menuCount:0,lastItem:null,lastActive:null,menuArray:new Array(),colorArray:new Array()},initialize:function(b,a,c){this.setOptions(a);a=this.options;var b=this.menu=document.id(b);b.setProperty("role","menubar");b.getElements(a.itemSelector).each(function(d){d.setProperty("role","presentation");d.getChildren()[0].setProperty("role","menuitem");d.getChildren()[0].setProperty("tabindex","-1");d.getChildren()[0].addEvents({focus:function(e){this.uncolor();if(e.target!=null){a.elementWithFocus=e.target;this.color();this.setActive()}}.bind(this),blur:function(){a.elementWithFocus=null}.bind(this),mouseenter:function(e){if(e.target!=null){this.options.elementWithFocus=e.target;this.recolor()}}.bind(this),mouseleave:function(){this.uncolorAll()}.bind(this)})}.bind(this));b.getElements(a.itemSelector)[0].getChildren()[0].setProperty("tabindex","0");b.getElements(a.itemSelector+" > "+a.listSelector).each(function(e){this.fireEvent("initialize",e);var d=e.getParent(a.itemSelector);d.getChildren()[0].setProperty("aria-haspopup","true");e.setProperty("role","menu");e.setProperty("aria-activedescendant","activeItem");d.getChildren()[0].removeEvent("mouseenter");d.getChildren()[0].removeEvent("mouseleave");d.addEvents({mouseenter:function(g){if(g.target!=null){if(this.options.colorArray.length!=0){this.closeAll()}var f=g.target;while(f.get("tag")!="li"){f=f.getParent()}this.options.elementWithFocus=f;this.recolor();this.openSub(e,d)}}.bind(this),mouseleave:function(f){this.uncolorAll();this.closeSub(e,d);this.options.lastItem=null;this.options.elementWithFocus=null}.bind(this),click:function(){return}})},this);b.getElements(a.itemSelector).each(function(d){d.getChildren()[0].addEvents({keydown:function(f){var h;if(window.event){var g=window.event;h=g.keyCode}else{h=f.code}switch(h){case 9:this.closeAll();break;case 13:this.open();break;case 32:this.open();break;case 27:this.close();break;case 37:if(this.options.menuCount==0){this.prev()}else{if(this.options.menuCount>0){this.close()}}break;case 38:if(this.options.menuCount==0){this.open()}else{if(this.options.menuCount>0){if(this.options.lastItem!=null){this.focChild();this.options.lastItem=null}else{this.prev()}}}break;case 39:if(this.options.menuCount==0){this.next()}else{if(this.options.menuCount>0){this.open()}}break;case 40:if(this.options.menuCount==0){this.open()}else{if(this.options.menuCount>0){if(this.options.lastItem!=null){this.focLastChild();this.options.lastItem=null}else{this.next()}}}break;default:break}}.bind(this)})}.bind(this))},toElement:function(){return this.menu},openSub:function(a,b){b.store("DropDownOpen",true);clearTimeout(this.options.timer);if(this.options.mouseoverDelay){timer=this.fireEvent.delay(this.options.mouseoverDelay,this,["open",a])}else{this.fireEvent("open",a)}this.options.menuCount++},open:function(){var b=null,a=null;if(this.options.elementWithFocus!=null){if(this.options.elementWithFocus.getChildren("ul")!=null){a=this.options.elementWithFocus.getParent();b=this.options.elementWithFocus.getNext();if((b!=null)&&(a!=null)){this.options.menuArray.push(new Array(b,a));this.openSub(b,a);window.setTimeout(function(){this.focChild()}.bind(this),30)}}}},closeSub:function(a,b){b.store("DropDownOpen",false);clearTimeout(this.options.timer);timer=(function(){if(!b.retrieve("DropDownOpen")){this.fireEvent("close",a)}}).delay(this.options.mouseoutDelay,this);if(this.options.menuCount>0){this.options.menuCount=this.options.menuCount-1}},close:function(){var b=null,a=null;if(this.options.elementWithFocus!=null){if(this.options.menuArray.getLast()!=null){b=this.options.menuArray.getLast()[0];a=this.options.menuArray.getLast()[1];if(b!=null&&a!=null){this.options.menuArray.pop();this.focParent();this.closeSub(b,a)}}}},closeAll:function(){this.options.menuArray.reverse();this.options.menuArray.each(function(b,a){this.closeSub(b[0],b[1])}.bind(this));this.uncolorAll();this.options.menuArray=new Array();this.options.menuCount=0;this.options.elementWithFocus=null;this.options.lastItem=null},next:function(){if(this.options.elementWithFocus!=null){this.uncolor();if(this.options.elementWithFocus.getParent().getNext()!=null){var a=this.options.elementWithFocus.getParent().getNext().getChildren()[0];a.focus()}else{var a=this.options.elementWithFocus.getParent().getParent().getChildren()[0].getChildren()[0];a.focus()}}},prev:function(){if(this.options.elementWithFocus!=null){this.uncolor();if(this.options.elementWithFocus.getParent().getPrevious()!=null){var b=this.options.elementWithFocus.getParent().getPrevious().getChildren()[0];b.focus()}else{var a=this.options.elementWithFocus.getParent().getParent().getChildren().length;var b=this.options.elementWithFocus.getParent().getParent().getChildren()[a-1].getChildren()[0];b.focus()}}},focChild:function(){if(this.options.elementWithFocus!=null){if(this.options.elementWithFocus.getNext().getChildren()[0]!=null){var a=this.options.elementWithFocus.getNext().getChildren()[0].getChildren()[0];a.focus()}}},focLastChild:function(){if(this.options.elementWithFocus!=null){var a=this.options.elementWithFocus.getNext().getChildren().length;var b=this.options.elementWithFocus.getNext().getChildren()[a-1].getChildren()[0];b.focus()}},focParent:function(){if(this.options.elementWithFocus!=null){var a=this.options.elementWithFocus.getParent().getParent().getPrevious();a.focus()}},color:function(){var a=this.options.elementWithFocus;if(a!=null){while(a.get("tag")!="li"){a=a.getParent()}a.addClass("focus");this.options.colorArray.push(a)}},uncolor:function(){var a=this.options.elementWithFocus;if(a!=null){while(a.get("tag")!="li"){a=a.getParent()}a.removeClass("focus");this.options.colorArray.pop(a)}},uncolorAll:function(){this.options.colorArray.each(function(a){while(a.get("tag")!="li"){a=a.getParent()}this.removeMarkups(a)}.bind(this));this.options.colorArray=new Array()},removeMarkups:function(a){if(a!=null){a.setProperty("id","");a.removeClass("focus")}},recolor:function(){var a=this.options.elementWithFocus;var b=true;if(a!=null){this.options.colorArray=new Array();while(a.getProperty("id")!="nav"){if(a.get("tag")=="li"){b?a.setProperty("id","activeItem"):a.addClass("focus");b=false;this.options.colorArray.push(a)}a=a.getParent()}}},setActive:function(b){if(b!=null){this.options.lastActive=b;b.setProperty("id","activeItem");return true}if(this.options.elementWithFocus!=null){var a=this.options.elementWithFocus;if(a.getProperty("role")=="menuitem"){a=a.getParent();if(this.options.lastActive!=null){this.options.lastActive.setProperty("id","")}this.options.lastActive=a;a.setProperty("id","activeItem");return true}}return false}});Element.implement({MooDropMenu:function(a){return this.store("MooDropMenu",new MooDropMenu(this,a))}});